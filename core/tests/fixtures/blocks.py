#!/usr/bin/env python3

import os
import asyncio
from bitcoinrpc import BitcoinRPC
from progress.bar import Bar
from time import sleep

BITCOIN_NODE_HOST = "192.168.178.54"
BITCOIN_NODE_PORT = 8332
BITCOIN_RPC_USER = os.environ["BITCOIN_RPC_USER"]
BITCOIN_RPC_PASSWORD = os.environ["BITCOIN_RPC_PASSWORD"]

RETRY = 12
RETRY_SLEEP = 10

FILENAME = "./test_blocks.csv"
BLOCKS = [
0, 2015, 2016, 4031, 4032, 6047, 6048, 8063, 8064, 10079, 10080, 12095, 12096, 14111, 14112, 16127,
16128, 18143, 18144, 20159, 20160, 22175, 22176, 24191, 24192, 26207, 26208, 28223, 28224, 30239,
30240, 32255, 32256, 34271, 34272, 36287, 36288, 38303, 38304, 40319, 40320, 42335, 42336, 44351,
44352, 46367, 46368, 48383, 48384, 50399, 50400, 52415, 52416, 54431, 54432, 56447, 56448, 58463,
58464, 60479, 60480, 62495, 62496, 64511, 64512, 66527, 66528, 68543, 68544, 70559, 70560, 72575,
72576, 74591, 74592, 76607, 76608, 78623, 78624, 80639, 80640, 82655, 82656, 84671, 84672, 86687,
86688, 88703, 88704, 90719, 90720, 92735, 92736, 94751, 94752, 96767, 96768, 98783, 98784, 100799,
100800, 102815, 102816, 104831, 104832, 106847, 106848, 108863, 108864, 110879, 110880, 112895,
112896, 114911, 114912, 116927, 116928, 118943, 118944, 120959, 120960, 122975, 122976, 124991,
124992, 127007, 127008, 129023, 129024, 131039, 131040, 133055, 133056, 135071, 135072, 137087,
137088, 139103, 139104, 141119, 141120, 143135, 143136, 145151, 145152, 147167, 147168, 149183,
149184, 151199, 151200, 153215, 153216, 155231, 155232, 157247, 157248, 159263, 159264, 161279,
161280, 163295, 163296, 165311, 165312, 167327, 167328, 169343, 169344, 171359, 171360, 173375,
173376, 175391, 175392, 177407, 177408, 179423, 179424, 181439, 181440, 183455, 183456, 185471,
185472, 187487, 187488, 189503, 189504, 191519, 191520, 193535, 193536, 195551, 195552, 197567,
197568, 199583, 199584, 201599, 201600, 203615, 203616, 205631, 205632, 207647, 207648, 209663,
209664, 211679, 211680, 213695, 213696, 215711, 215712, 217727, 217728, 219743, 219744, 221759,
221760, 223775, 223776, 225791, 225792, 227807, 227808, 229823, 229824, 231839, 231840, 233855,
233856, 235871, 235872, 237887, 237888, 239903, 239904, 241919, 241920, 243935, 243936, 245951,
245952, 247967, 247968, 249983, 249984, 251999, 252000, 254015, 254016, 256031, 256032, 258047,
258048, 260063, 260064, 262079, 262080, 264095, 264096, 266111, 266112, 268127, 268128, 270143,
270144, 272159, 272160, 274175, 274176, 276191, 276192, 278207, 278208, 280223, 280224, 282239,
282240, 284255, 284256, 286271, 286272, 288287, 288288, 290303, 290304, 292319, 292320, 294335,
294336, 296351, 296352, 298367, 298368, 300383, 300384, 302399, 302400, 304415, 304416, 306431,
306432, 308447, 308448, 310463, 310464, 312479, 312480, 314495, 314496, 316511, 316512, 318527,
318528, 320543, 320544, 322559, 322560, 324575, 324576, 326591, 326592, 328607, 328608, 330623,
330624, 332639, 332640, 334655, 334656, 336671, 336672, 338687, 338688, 340703, 340704, 342719,
342720, 344735, 344736, 346751, 346752, 348767, 348768, 350783, 350784, 352799, 352800, 354815,
354816, 356831, 356832, 358847, 358848, 360863, 360864, 362879, 362880, 364895, 364896, 366911,
366912, 368927, 368928, 370943, 370944, 372959, 372960, 374975, 374976, 376991, 376992, 379007,
379008, 381023, 381024, 383039, 383040, 385055, 385056, 387071, 387072, 389087, 389088, 391103,
391104, 393119, 393120, 395135, 395136, 397151, 397152, 399167, 399168, 401183, 401184, 403199,
403200, 405215, 405216, 407231, 407232, 409247, 409248, 411263, 411264, 413279, 413280, 415295,
415296, 417311, 417312, 419327, 419328, 421343, 421344, 423359, 423360, 425375, 425376, 427391,
427392, 429407, 429408, 431423, 431424, 433439, 433440, 435455, 435456, 437471, 437472, 439487,
439488, 441503, 441504, 443519, 443520, 445535, 445536, 447551, 447552, 449567, 449568, 451583,
451584, 453599, 453600, 455615, 455616, 457631, 457632, 459647, 459648, 461663, 461664, 463679,
463680, 465695, 465696, 467711, 467712, 469727, 469728, 471743, 471744, 473759, 473760, 475775,
475776, 477791, 477792, 479807, 479808, 481823, 481824, 483839, 483840, 485855, 485856, 487871,
487872, 489887, 489888, 491903, 491904, 493919, 493920, 495935, 495936, 497951, 497952, 499967,
499968, 501983, 501984, 503999, 504000, 506015, 506016, 508031, 508032, 510047, 510048, 512063,
512064, 514079, 514080, 516095, 516096, 518111, 518112, 520127, 520128, 522143, 522144, 524159,
524160, 526175, 526176, 528191, 528192, 530207, 530208, 532223, 532224, 534239, 534240, 536255,
536256, 538271, 538272, 540287, 540288, 542303, 542304, 544319, 544320, 546335, 546336, 548351,
548352, 550367, 550368, 552383, 552384, 554399, 554400, 556415, 556416, 558431, 558432, 560447,
560448, 562463, 562464, 564479, 564480, 566495, 566496, 568511, 568512, 570527, 570528, 572543,
572544, 574559, 574560, 576575, 576576, 578591, 578592, 580607, 580608, 582623, 582624, 584639,
584640, 586655, 586656, 588671, 588672, 590687, 590688, 592703, 592704, 594719, 594720, 596735,
596736, 598751, 598752, 600767, 600768, 602783, 602784, 604799, 604800, 606815, 606816, 608831,
608832, 610847, 610848, 612863, 612864, 614879, 614880, 616895, 616896, 618911, 618912, 620927,
620928, 622943, 622944, 624959, 624960, 626975, 626976, 628991, 628992, 631007, 631008, 633023,
633024, 635039, 635040, 637055, 637056, 639071, 639072, 641087, 641088, 643103, 643104, 645119,
645120, 647135, 647136, 649151, 649152, 651167, 651168, 653183, 653184, 655199, 655200, 657215,
657216, 659231, 659232, 661247, 661248, 663263, 663264, 665279, 665280, 667295, 667296, 669311,
669312, 671327, 671328, 673343, 673344, 675359, 675360, 677375, 677376, 679391, 679392, 681407,
681408, 683423, 683424, 685439, 685440, 687455, 687456, 689471, 689472, 691487, 691488, 693503,
693504, 695519, 695520, 697535, 697536, 699551, 699552, 701567, 701568, 703583, 703584, 705599,
705600, 707615, 707616, 709631, 709632, 711647, 711648, 713663, 713664, 715679, 715680, 717695,
717696, 719711, 719712, 721727, 721728, 723743, 723744, 725759, 725760, 727775, 727776, 729791,
729792, 731807, 731808, 733823, 733824, 735839, 735840, 737855, 737856, 739871, 739872, 741887,
741888, 743903, 743904, 745919, 745920, 747935, 747936, 749951, 749952, 751967, 751968, 753983,
753984, 755999, 756000, 758015, 758016, 760031, 760032, 762047, 762048, 764063, 764064, 766079,
766080, 768095, 768096, 770111, 770112, 772127, 772128, 774143, 774144, 776159, 776160, 778175,
778176, 780191, 780192, 782207, 782208, 784223, 784224, 786239, 786240, 788255, 788256, 790271,
790272, 792287, 792288, 794303, 794304, 796319, 796320, 798335, 798336, 800351, 800352, 802367,
802368, 804383, 804384, 806399, 806400, 808415, 808416, 810431, 810432, 812447, 812448, 814463,
814464, 816479, 816480, 818495, 818496, 820511, 820512, 822527, 822528, 824543, 824544, 826559,
826560, 828575, 828576, 830591, 830592, 832607, 832608, 834623, 834624, 836639, 836640, 838655,
838656, 840236
]

# FILENAME = "./blocks.csv"
# BLOCKS = [0, 1, 2015, 30240, 32255, 32256, 34271, 34272, 36287, 227836, 229824, 231839,
#             359875, 384548, 398364, 431424, 433439, 477120, 633024, 635039, 431423, 433440]


BLOCKS.sort()

async def read_block(i):
    block = None
    hash = None

    async with BitcoinRPC.from_config(f"http://{BITCOIN_NODE_HOST}:{BITCOIN_NODE_PORT}", (BITCOIN_RPC_USER, BITCOIN_RPC_PASSWORD)) as rpc:
        retry = RETRY
        while retry > 0:
            try:
                hash = await rpc.getblockhash(i)
                block = await rpc.getblock(hash, 0, 30)
                break
            except:
                retry -= 1
                sleep(RETRY_SLEEP)

    return (i, hash, block)

async def main():
    with Bar('Loading', fill='@', suffix='%(index)d/%(max)d - %(percent).1f%% - %(eta)ds', max=len(BLOCKS)) as bar:
        with open(FILENAME, "w") as file:
            # file.write("BLOCK_HEIGHT, BLOCK_ID, BLOCK\n")

            for i in BLOCKS:
                (i, hash, block) = await read_block(i)
                file.write(f"{i}, {hash}, {block}\n")
                file.flush()

                bar.next()
    print(f"File {FILENAME} wrote.")

if __name__ == "__main__":
    asyncio.run(main())
